{"version":3,"file":"waiter.js","sourceRoot":"","sources":["../../src/waiter.ts"],"names":[],"mappings":";;;AAAA,MAAa,MAAM;IACjB,EAAE,CAA6B;IAC/B,KAAK,GAAY,KAAK,CAAA;IACtB,KAAK,GAAQ,IAAI,CAAA;IACjB,QAAQ,GAAY,KAAK,CAAA;IACzB,QAAQ,GAAY,KAAK,CAAA;IACzB,IAAI,GAAY,KAAK,CAAA;IACrB,SAAS,GAAY,KAAK,CAAA;IAC1B,YAAY,CAAS;IACrB,OAAO,CAAe;IACtB,OAAO,GAAmC,IAAI,CAAA;IAE9C,YACE,OAA4B,EAC5B,EAAsB,EACtB,eAAwB,KAAK;QAE7B,IAAI,CAAC,EAAE,GAAG,EAAE,CAAA;QACZ,IAAI,CAAC,YAAY,GAAG,CAAC,CAAC,YAAY,CAAA;QAClC,IAAI,CAAC,OAAO,GAAG,IAAI,OAAO,CAAO,GAAG,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,OAAO,GAAG,GAAG,CAAC,CAAC,CAAA;QAC7D,OAAO;aACJ,IAAI,CAAC,KAAK,CAAC,EAAE;YACZ,IAAI,IAAI,CAAC,IAAI,EAAE;gBACb,OAAM;aACP;YAED,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAA;YACpB,IAAI,CAAC,KAAK,GAAG,KAAK,CAAA;YAClB,IAAI,CAAC,IAAI,GAAG,IAAI,CAAA;YAChB,IAAI,CAAC,MAAM,EAAE,CAAA;QACf,CAAC,CAAC;aACD,KAAK,CAAC,EAAE,CAAC,EAAE,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC,CAAA;IACjC,CAAC;IAED,MAAM,CAAC,EAAO;QACZ,IAAI,IAAI,CAAC,IAAI,EAAE;YACb,OAAM;SACP;QAED,IAAI,CAAC,KAAK,GAAG,EAAE,CAAA;QACf,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAA;QACpB,IAAI,CAAC,IAAI,GAAG,IAAI,CAAA;QAChB,IAAI,CAAC,MAAM,EAAE,CAAA;IACf,CAAC;IAED,oCAAoC;IACpC,KAAK,CAAC,EAAS;QACb,IAAI,IAAI,CAAC,IAAI,EAAE;YACb,OAAM;SACP;QAED,IAAI,CAAC,KAAK,GAAG,IAAI,CAAA;QACjB,IAAI,CAAC,SAAS,GAAG,KAAK,CAAA;QACtB,IAAI,CAAC,IAAI,GAAG,IAAI,CAAA;QAChB,IAAI,CAAC,KAAK,GAAG,EAAE,CAAA;QACf,gDAAgD;QAChD,sCAAsC;QACtC,IAAI,CAAC,QAAQ,GAAG,CAAC,IAAI,CAAC,YAAY,CAAA;QAClC,OAAO,IAAI,CAAC,MAAM,EAAE,CAAA;IACtB,CAAC;IAED,MAAM;QACJ,IAAI,IAAI,CAAC,KAAK,IAAI,IAAI,CAAC,IAAI,IAAI,CAAC,IAAI,CAAC,SAAS,EAAE;YAC9C,IAAI,CAAC,SAAS,GAAG,IAAI,CAAA;YACrB,IAAI,CAAC,EAAE,IAAI,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,CAAA;YACxB,IAAI,CAAC,OAAO,IAAI,IAAI,CAAC,OAAO,EAAE,CAAA;SAC/B;IACH,CAAC;CACF;AApED,wBAoEC","sourcesContent":["export class Waiter {\n  cb: null | ((w: Waiter) => any)\n  ready: boolean = false\n  value: any = null\n  resolved: boolean = false\n  rejected: boolean = false\n  done: boolean = false\n  finishing: boolean = false\n  expectReject: boolean\n  promise: Promise<void>\n  resolve: null | ((value?: any) => void) = null\n\n  constructor(\n    promise: Promise<any | void>,\n    cb: (w: Waiter) => any,\n    expectReject: boolean = false\n  ) {\n    this.cb = cb\n    this.expectReject = !!expectReject\n    this.promise = new Promise<void>(res => (this.resolve = res))\n    promise\n      .then(value => {\n        if (this.done) {\n          return\n        }\n\n        this.resolved = true\n        this.value = value\n        this.done = true\n        this.finish()\n      })\n      .catch(er => this.reject(er))\n  }\n\n  reject(er: any) {\n    if (this.done) {\n      return\n    }\n\n    this.value = er\n    this.rejected = true\n    this.done = true\n    this.finish()\n  }\n\n  // TODO: consider AbortSignal maybe?\n  abort(er: Error) {\n    if (this.done) {\n      return\n    }\n\n    this.ready = true\n    this.finishing = false\n    this.done = true\n    this.value = er\n    // make it clear that this is a problem by doing\n    // the opposite of what was requested.\n    this.rejected = !this.expectReject\n    return this.finish()\n  }\n\n  finish() {\n    if (this.ready && this.done && !this.finishing) {\n      this.finishing = true\n      this.cb && this.cb(this)\n      this.resolve && this.resolve()\n    }\n  }\n}\n"]}